{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Application Form - IET Membership{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="card-title mb-0">
                    <i class="bi bi-file-earmark-text"></i> Membership Application Form
                </h3>
            </div>
            <div class="card-body">
                {% if payment %}
                <div class="alert alert-info">
                    <h5><i class="bi bi-info-circle"></i> Payment Information</h5>
                    <p class="mb-2"><strong>Registration Fee:</strong> {{ registration_fee|floatformat:0 }} TZS</p>
                    <p class="mb-2"><strong>Payment Reference Number:</strong> <code>{{ payment.reference_number }}</code></p>
                    <p class="mb-0"><strong>Instructions:</strong> Please make payment using the reference number above. After payment, return here and submit your application.</p>
                </div>
                {% endif %}

                <form method="post" id="applicationForm">
                    {% csrf_token %}
                    
                    <h4 class="mt-4 mb-3">1. Personal Information</h4>
                    <div class="row">
                        <div class="col-md-4">{{ form.first_name|as_crispy_field }}</div>
                        <div class="col-md-4">{{ form.middle_name|as_crispy_field }}</div>
                        <div class="col-md-4">{{ form.last_name|as_crispy_field }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">{{ form.email|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.phone_number|as_crispy_field }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">{{ form.nationality|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.date_of_birth|as_crispy_field }}</div>
                    </div>

                    <h4 class="mt-4 mb-3">2. Address</h4>
                    <div class="row">
                        <div class="col-md-12">{{ form.address|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.city|as_crispy_field }}</div>
                    </div>

                    <h4 class="mt-4 mb-3">3. Academic Information</h4>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> <strong>University:</strong> University of Dar es Salaam
                    </div>
                    <div class="row">
                        <div class="col-md-6">{{ form.course|as_crispy_field }}</div>
                        <div class="col-md-6">{{ form.year_of_study|as_crispy_field }}</div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">{{ form.date_of_admission|as_crispy_field }}</div>
                    </div>
                    <div class="alert alert-success mt-3">
                        <i class="bi bi-check-circle"></i> <strong>Note:</strong> Your department will be automatically determined based on your selected course.
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="submit" name="save_draft" class="btn btn-outline-secondary">
                            <i class="bi bi-save"></i> Save as Draft
                        </button>
                        <button type="submit" name="submit_application" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Submit Application
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dobInput = document.getElementById('id_date_of_birth');
    const ageDisplay = document.getElementById('calculated_age');
    
    function calculateAge() {
        const dob = new Date(dobInput.value);
        if (!dobInput.value) {
            ageDisplay.value = '';
            return;
        }
        
        const today = new Date();
        let age = today.getFullYear() - dob.getFullYear();
        const monthDiff = today.getMonth() - dob.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < dob.getDate())) {
            age--;
        }
        
        ageDisplay.value = age + ' years';
    }
    
    // Calculate age on page load if DOB is already filled
    if (dobInput.value) {
        calculateAge();
    }
    
    // Calculate age when DOB changes
    dobInput.addEventListener('change', calculateAge);
});
</script>
{% endblock %}
